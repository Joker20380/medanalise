{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="ru">
  <head>
    <title>Дзагуров КДЛ</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/open-iconic-bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/magnific-popup.css' %}">
    <link rel="stylesheet" href="{% static 'css/aos.css' %}">
    <link rel="stylesheet" href="{% static 'css/ionicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/flaticon.css' %}">
    <link rel="stylesheet" href="{% static 'css/icomoon.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom_style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>

  <body data-spy="scroll" data-target=".site-navbar-target" data-offset="300">

    {% if not user.is_authenticated %}
    <div class="modal fade" id="signupChoiceModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Быстрая регистрация</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            {% if SOCIALACCOUNT_ENABLED %}
              <p class="mb-2 text-muted">
                Выберите удобный способ регистрации через соцсети:
              </p>

              <div class="mb-3">
                {% include "socialaccount/snippets/login.html" with page_layout="entrance" %}
              </div>

              <hr>
            {% endif %}

            <p class="mb-2 text-muted">
              Или создайте аккаунт с помощью e-mail:
            </p>
            <a href="{% url 'account_signup' %}" class="btn btn-outline-primary btn-block">
              Регистрация по e-mail
            </a>
          </div>

        </div>
      </div>
    </div>
    {% endif %}

    <!-- TOP BAR -->
    <div class="py-1 bg-black top">
      <div class="container">
        <div class="d-flex flex-wrap justify-content-between align-items-center text-white"
             style="gap:10px; font-size:14px; line-height:1;">

          <!-- Телефон -->
          <div class="d-flex align-items-center">
            <i class="icon-phone2 mr-2"></i>
            <a id="topbar-phone-link"
               href="tel:{{ current_office.phone|default:'+79180000000' }}"
               class="text-white">
              <span id="topbar-phone-text">{{ current_office.phone|default:'+7(918)000-00-00' }}</span>
            </a>
          </div>

          <!-- Почта -->
          <div class="d-flex align-items-center">
            <i class="icon-paper-plane mr-2"></i>
            <a id="topbar-email-link"
               href="mailto:{{ current_office.email|default:'youremail@email.ru' }}"
               class="text-white">
              <span id="topbar-email-text">{{ current_office.email|default:'youremail@email.ru' }}</span>
            </a>
          </div>

          <!-- Селектор офисов -->
          <div class="d-flex align-items-center">
            <i class="icon-map-marker mr-2"></i>
            <label for="officeSwitcher" class="mb-0 mr-2 d-none d-sm-inline">Офис:</label>
            <select id="officeSwitcher"
                    class="office-select"
                    style="min-width:150px;">
              {% for o in offices_for_switcher %}
                <option value="{{ o.id }}" {% if o.id == current_office.id %}selected{% endif %}>
                  {% if o.is_main %}★ {% endif %}{{ o.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Авторизация -->
          {% if request.user.is_authenticated %}
          <div class="d-flex align-items-center">
            <a href="#" class="text-white mr-3">{{ user.username }}</a>
            <a href="{% url 'account_logout' %}" class="text-white">Выйти</a>
          </div>
          {% else %}
          <div class="d-flex align-items-center">
            <p class="mb-0 register-link">
              <a href="#" class="text-white" data-toggle="modal" data-target="#signupChoiceModal">
                Регистрация
              </a>
              <a href="{% url 'account_login' %}" class="text-white">Войти</a>
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light site-navbar-target" id="ftco-navbar">
      <div class="container">
        <a href="{% url 'index' %}">
          <img style="width:200px" src="{% static 'images/logo_med.png' %}" alt="Logo">
        </a>
        <button class="navbar-toggler js-fh5co-nav-toggle fh5co-nav-toggle"
                type="button"
                data-toggle="collapse"
                data-target="#ftco-nav"
                aria-controls="ftco-nav"
                aria-expanded="false"
                aria-label="Toggle navigation">
          <span class="oi oi-menu"></span> Меню
        </button>

        <div class="collapse navbar-collapse" id="ftco-nav">
          <ul class="navbar-nav nav ml-auto">
            <li class="nav-item"><a href="{% url 'index' %}" class="nav-link"><span>Домой</span></a></li>
            <li class="nav-item"><a href="{% url 'analysis' %}" class="nav-link"><span>Анализы</span></a></li>
            <li class="nav-item"><a href="#" class="nav-link"><span>Документы</span></a></li>
            <li class="nav-item"><a href="{% url 'doctors' %}" class="nav-link"><span>Доктора</span></a></li>
            <li class="nav-item"><a href="{% url 'blog' %}" class="nav-link"><span>Блог</span></a></li>
            <li class="nav-item"><a href="{% url 'contacts' %}" class="nav-link"><span>Контакты</span></a></li>
            <li class="nav-item cta mr-md-2"><a href="#" class="nav-link">Запись на прием</a></li>
          </ul>
        </div>
      </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- FOOTER -->
    <footer class="ftco-footer ftco-section img" style="background-image: url({% static 'images/footer-bg.jpg' %});">
      <div class="overlay"></div>
      <div class="container-fluid px-md-5">
        <div class="row mb-5">
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <a href="{% url 'index' %}">
                <img style="width:120px" src="{% static 'images/logo.webp' %}" alt="Logo">
              </a>
              <ul class="ftco-footer-social list-unstyled mt-5">
                <li class="ftco-animate"><a href="#"><span class="icon-vk"></span></a></li>
                <li class="ftco-animate"><a href="#"><span class="icon-telegram"></span></a></li>
                <li class="ftco-animate"><a href="#"><span class="icon-whatsapp"></span></a></li>
              </ul>
            </div>
          </div>

          <div class="col-md">
            <div class="ftco-footer-widget mb-4 ml-md-4">
              <h2 class="ftco-heading-2">Филиалы</h2>
              <ul class="list-unstyled">
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Владикавказ</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Алагир</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Октябрьское</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Хатуэй</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Кахун</a></li>
              </ul>
            </div>
          </div>

          <div class="col-md">
            <div class="ftco-footer-widget mb-4 ml-md-4">
              <h2 class="ftco-heading-2">Ссылки</h2>
              <ul class="list-unstyled">
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Домой</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>О нас</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Филиалы</a></li>
                <li><a href="{% url 'doctors' %}"><span class="icon-long-arrow-right mr-2"></span>Врачи</a></li>
                <li><a href="{% url 'blog' %}"><span class="icon-long-arrow-right mr-2"></span>Блог</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Цены</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Контакты</a></li>
              </ul>
            </div>
          </div>

          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">Услуги</h2>
              <ul class="list-unstyled">
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Срочные анализы</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Квалифицированные доктора</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Выездное обслуживание</a></li>
                <li><a href="#"><span class="icon-long-arrow-right mr-2"></span>Поддержка 24 часа</a></li>
              </ul>
            </div>
          </div>

          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">Есть вопросы?</h2>
              <div class="block-23 mb-3">
                <ul>
                  <li><span class="icon icon-map-marker"></span><span class="text">г. Владикавказ, Московская 3а</span></li>
                  <li><a href="#"><span class="icon icon-phone"></span><span class="text">+79188320000</span></a></li>
                  <li><a href="#"><span class="icon icon-envelope pr-4"></span><span class="text">dzagurov@mail.ru</span></a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 text-center">
            <p>
              Copyright &copy;<script>document.write(new Date().getFullYear());</script>
              All rights reserved | Made with <i class="icon-heart color-danger"></i> by
              <a href="#" target="_blank">WhiteCat</a>
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- loader -->
    <div id="ftco-loader" class="show fullscreen">
      <svg class="circular" width="48" height="48">
        <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/>
        <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/>
      </svg>
    </div>

    <!-- JS -->
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/jquery-migrate-3.0.1.min.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/jquery.easing.1.3.js' %}"></script>
    <script src="{% static 'js/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'js/jquery.stellar.min.js' %}"></script>
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'js/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'js/aos.js' %}"></script>
    <script src="{% static 'js/jquery.animateNumber.min.js' %}"></script>
    <script src="{% static 'js/scrollax.min.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>

    <script>
      (function() {
        const urlTemplate = "{% url 'contact_summary' 0 %}";

        function summaryUrl(id) {
          return urlTemplate.replace("/0/", `/${id}/`);
        }

        const select    = document.getElementById('officeSwitcher');
        const phoneText = document.getElementById('topbar-phone-text');
        const phoneLink = document.getElementById('topbar-phone-link');
        const emailText = document.getElementById('topbar-email-text');
        const emailLink = document.getElementById('topbar-email-link');

        function setCookie(name, value, days) {
          const d = new Date();
          d.setTime(d.getTime() + (days*24*60*60*1000));
          document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/";
        }

        function telHref(str) {
          return 'tel:' + (str || '').replace(/[^\d+]/g,'');
        }

        select && select.addEventListener('change', async function() {
          const id = this.value;
          try {
            const resp = await fetch(summaryUrl(id), { headers: {'X-Requested-With':'XMLHttpRequest'} });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            const phone = (data.phone || '').trim();
            const email = (data.email || '').trim();

            if (phone) {
              phoneText.textContent = phone;
              phoneLink.setAttribute('href', telHref(phone));
            } else {
              phoneText.textContent = '+7(918)000-00-00';
              phoneLink.setAttribute('href', 'tel:+79180000000');
            }

            if (email) {
              emailText.textContent = email;
              emailLink.setAttribute('href', 'mailto:' + email);
            } else {
              emailText.textContent = 'youremail@email.ru';
              emailLink.setAttribute('href', 'mailto:youremail@email.ru');
            }

            setCookie('office_id', id, 365);
          } catch (e) {
            console.warn('Ошибка при обновлении офиса', e);
          }
        });
      })();
    </script>

    {% include 'includes/cookie_notice.html' %}

    {% if user.is_authenticated %}
    <!-- =============================== -->
    <!-- Чат-виджет ассистента -->
    <!-- =============================== -->
    <div id="chat-widget"
         class="chat-widget"
         data-bootstrap-url="{% url 'chat:chat_api_bootstrap' %}"
         data-messages-url="{% url 'chat:chat_api_messages' %}"
         data-send-url="{% url 'chat:chat_api_send' %}">

      <div class="chat-widget-header">
        <span>Ассистент</span>
        <button type="button" class="chat-widget-toggle" aria-label="Свернуть">
          &times;
        </button>
      </div>

      <div class="chat-widget-body">
        <div class="chat-messages" id="chat-messages"></div>

        <form id="chat-form" class="chat-form" autocomplete="off">
          <textarea
            id="chat-input"
            rows="2"
            class="form-control"
            placeholder="Напишите сообщение..."
          ></textarea>
          <button type="submit" class="btn btn-primary chat-send-btn w-100 mt-2">
            Отправить
          </button>
        </form>
      </div>
    </div>

    <!-- JS логика чат-виджета -->
    <script src="{% static 'js/chat_widget.js' %}"></script>
    {% endif %}

  </body>
</html>
