{% extends "dzagurov/base.html" %}
{% load static %}
{% load i18n %}
{% load allauth account %}

{% block title %}
    {% trans "Sign In" %}
{% endblock title %}

{% block content %}

  <!-- Hero -->
  <section class="ftco-intro img" style="background-image: url({% static 'images/bg_2.jpg' %});">
    <div class="overlay"></div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-9 text-center">
          <h2>Войти</h2>
          <p>Для использования всего функционала необходимо войти</p>
          <p class="mb-0">
            <a href="#" class="btn btn-white px-4 py-3">Записаться на прием</a>
          </p>
        </div>
      </div>
    </div>
  </section>

  {# Глобальные ошибки формы #}
  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}
  {% for field in form %}
    {% for err in field.errors %}
      <div class="alert alert-danger">{{ err }}</div>
    {% endfor %}
  {% endfor %}

  {# Сообщения Django messages #}
  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <!-- Breadcrumbs -->
  <section class="blog-banner-area" id="category">
    <div class="container h-100">
      <div class="blog-banner">
        <div class="text-center">
          <nav aria-label="breadcrumb" class="banner-breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'index' %}">Домой</a></li>
              <li class="breadcrumb-item active" aria-current="page">Войти</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </section>

  <!-- Login Box -->
  <section class="login_box_area section-margin">
    <div class="container">
      <div class="row">
        <div class="col-lg-6">

          <div class="card shadow-sm border-0">
            <div class="card-body p-4">
              <h5 class="card-title mb-3">Войти</h5>

              {% if not SOCIALACCOUNT_ONLY %}

                <div class="form-group mb-3">
                  <p class="mb-0">
                    Если у вас ещё нет аккаунта, пожалуйста,
                    <a href="{{ signup_url }}">зарегистрируйтесь</a>.
                  </p>
                </div>

                <form class="row login_form" action="{% url 'account_login' %}" method="post" novalidate="novalidate">
                  {% csrf_token %}

                  {# Поля формы — тот же include, что и на signup #}
                  {% include "includes/form_fields.html" with form=form %}

                  {{ redirect_field }}

                  <div class="col-md-12 form-group mt-3">
                    <button type="submit" class="btn btn-primary">Войти</button>
                  </div>
                </form>
              {% endif %}

              {% if LOGIN_BY_CODE_ENABLED or PASSKEY_LOGIN_ENABLED %}
                <hr>
                <div class="d-grid gap-2">
                  {% if PASSKEY_LOGIN_ENABLED %}
                    <button type="submit"
                            form="mfa_login"
                            id="passkey_login"
                            class="btn btn-outline-primary">
                      {% trans "Sign in with a passkey" %}
                    </button>
                  {% endif %}
                  {% if LOGIN_BY_CODE_ENABLED %}
                    <a href="{{ request_login_code_url }}" class="btn btn-outline-primary">
                      {% trans "Mail me a sign-in code" %}
                    </a>
                  {% endif %}
                </div>
              {% endif %}

              {% if SOCIALACCOUNT_ENABLED %}
                <div class="mt-3">
                  {% include "socialaccount/snippets/login.html" with page_layout="entrance" %}
                </div>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  {# Локальный фикс для чекбокса: размер и выравнивание #}
  <style>
    /* уменьшаем чекбокс и убираем "монстра" от глобальных стилей */
    .login_box_area .login_form input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      transform: none;
      -webkit-transform: none;
      margin-right: 0.5rem;
      vertical-align: middle;
      display: inline-block;
    }

    /* если form_fields.html завернул чекбокс в .form-group — прижимаем влево */
    .login_box_area .login_form .form-group {
      text-align: left;
    }

    /* подстраховка: если label идет рядом с чекбоксом */
    .login_box_area .login_form label {
      display: inline-block;
      margin-bottom: 0.2rem;
    }
  </style>

{% endblock content %}

{% block extra_body %}
    {{ block.super }}
    {% if PASSKEY_LOGIN_ENABLED %}
        {% include "mfa/webauthn/snippets/login_script.html" with button_id="passkey_login" %}
    {% endif %}
{% endblock %}
