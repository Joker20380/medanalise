{% extends "dzagurov/base.html" %}
{% load static %}
{% load i18n %}
{% load allauth account %}

{% block title %}{% endblock %}

{% block content %}
{% if request.GET.modal == "1" %}
  <div id="auth-modal-inner" class="auth-glass auth-glass--login">

    <div class="auth-glass-head">
      <div class="auth-glass-sub">Войдите, чтобы писать в чат и пользоваться сервисами</div>
    </div>

    {# Ошибки #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% for field in form %}
      {% for err in field.errors %}
        <div class="alert alert-danger">{{ err }}</div>
      {% endfor %}
    {% endfor %}

    <form data-auth-modal-form="1" action="{% url 'account_login' %}" method="post" novalidate>
      {% csrf_token %}

      {# Поля формы #}
      {% include "includes/form_fields.html" with form=form %}

      {# redirect field (allauth) #}
      {{ redirect_field }}

      <button type="submit" class="btn btn-primary btn-block mt-2">Войти</button>

      <div class="mt-3 auth-glass-foot">
        Нет аккаунта?
        <a href="{% url 'account_signup' %}" class="auth-glass-link">Регистрация</a>
      </div>

      {% if SOCIALACCOUNT_ENABLED %}
        <hr class="auth-glass-hr">
        <div class="mt-2">
          {% include "socialaccount/snippets/login.html" with page_layout="entrance" %}
        </div>
      {% endif %}
    </form>

    <style>
      /* ===== Modal glass polish + checkbox fix (scoped) ===== */
      #auth-modal-inner.auth-glass{
        padding: 16px;
        border-radius: 16px;
        background: linear-gradient(180deg, rgba(17,108,179,.18), rgba(255,255,255,.10));
        border: 1px solid rgba(255,255,255,.22);
        backdrop-filter: blur(18px) saturate(155%);
        -webkit-backdrop-filter: blur(18px) saturate(155%);
        box-shadow: 0 18px 60px rgba(0,0,0,.18);
        color: rgba(20,24,32,.92);
      }

      #auth-modal-inner .auth-glass-head{ margin-bottom: 12px; }
      #auth-modal-inner .auth-glass-title{
        font-weight: 700; font-size: 18px; line-height: 1.2; color: rgba(20,24,32,.92);
      }
      #auth-modal-inner .auth-glass-sub{
        margin-top: 6px; font-size: 13px; color: rgba(20,24,32,.70);
      }

      #auth-modal-inner .auth-glass-hr{
        border: 0; height: 1px; background: rgba(255,255,255,.22);
      }

      #auth-modal-inner .auth-glass-foot{
        color: rgba(20,24,32,.78);
      }
      #auth-modal-inner .auth-glass-link{
        color: rgba(20,24,32,.92);
        text-decoration: underline;
        font-weight: 650;
      }

      /* Принудительно нормальный чекбокс (убираем глобальные scale/zoom) */
      #auth-modal-inner input[type="checkbox"]{
        -webkit-appearance: checkbox;
        appearance: checkbox;
        width: 16px !important;
        height: 16px !important;
        transform: none !important;
        -webkit-transform: none !important;
        zoom: 1 !important;
        margin: 0 8px 0 0 !important;
        vertical-align: middle !important;
        display: inline-block !important;
      }

      /* Чтобы label рядом не “уплывал” */
      #auth-modal-inner label{
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px;
      }

      /* Кнопка в бренде */
      #auth-modal-inner .btn-primary{
        background: #116cb3 !important;
        border: 0 !important;
        border-radius: 14px !important;
        font-weight: 700;
      }
      #auth-modal-inner .btn-primary:hover{
        background: #0f5fa0 !important;
      }
    </style>

  </div>
{% else %}

  <!-- Страничный вариант -->
  <section class="ftco-intro img" style="background-image: url({% static 'images/bg_2.jpg' %});">
    <div class="overlay"></div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-9 text-center">
          <h2>Войти</h2>
          <p>Для использования всего функционала необходимо войти</p>
        </div>
      </div>
    </div>
  </section>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}
  {% for field in form %}
    {% for err in field.errors %}
      <div class="alert alert-danger">{{ err }}</div>
    {% endfor %}
  {% endfor %}

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <section class="login_box_area section-margin auth-page">
    <div class="container">
      <div class="row">
        <div class="col-lg-6">

          <div class="card shadow-sm border-0">
            <div class="card-body p-4">
              <h5 class="card-title mb-3">Войти</h5>

              {% if not SOCIALACCOUNT_ONLY %}
                <div class="form-group mb-3">
                  <p class="mb-0">
                    Если у вас ещё нет аккаунта, пожалуйста,
                    <a href="{{ signup_url }}">зарегистрируйтесь</a>.
                  </p>
                </div>

                <form class="row login_form" action="{% url 'account_login' %}" method="post" novalidate="novalidate">
                  {% csrf_token %}
                  {% include "includes/form_fields.html" with form=form %}
                  {{ redirect_field }}
                  <div class="col-md-12 form-group mt-3">
                    <button type="submit" class="btn btn-primary">Войти</button>
                  </div>
                </form>
              {% endif %}

              {% if SOCIALACCOUNT_ENABLED %}
                <div class="mt-3">
                  {% include "socialaccount/snippets/login.html" with page_layout="entrance" %}
                </div>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>

    <style>
      /* Страничный фикс чекбокса (на случай глобальных scale) */
      .auth-page input[type="checkbox"]{
        width: 16px !important;
        height: 16px !important;
        transform: none !important;
        -webkit-transform: none !important;
        zoom: 1 !important;
        margin-right: 8px !important;
        vertical-align: middle !important;
      }
    </style>
  </section>

{% endif %}
{% endblock %}
