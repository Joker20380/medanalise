import re
from dataclasses import dataclass
from typing import Optional, List, Tuple

@dataclass(frozen=True)
class Reply:
    text: str
    tag: str = "template"
    handoff: bool = False

def _norm(s: str) -> str:
    s = (s or "").strip().lower()
    s = re.sub(r"\s+", " ", s)
    return s

_RULES: List[Tuple[str, Reply]] = [
    (r"^(привет|здравствуйте|добрый день|добрый вечер|доброе утро)\b",
     Reply("Здравствуйте! Я ассистент КДЛ. Подскажите: вам нужны цены, подготовка к анализу, адрес/график или сроки готовности?")),

    (r"\b(адрес|где вы|где находитесь|как доехать|локация)\b",
     Reply("Подскажите, пожалуйста, какой филиал интересует — я отправлю точный адрес и ориентиры.")),

    (r"\b(график|режим работы|когда работаете|часы работы)\b",
     Reply("Уточните филиал — я подскажу график работы и время забора анализов.")),

    (r"\b(цена|стоимость|сколько стоит|прайс|цены)\b",
     Reply("Цена зависит от анализа. Напишите название анализа (или что нужно проверить) — подскажу ориентир и подготовку.")),

    (r"\b(подготовк|натощак|можно есть|вода|алкоголь|курить)\b",
     Reply("По подготовке часто нужно натощак 8–12 часов, воду обычно можно. Напишите, какой анализ — дам точные правила.")),

    (r"\b(результат|готовность|когда будет|срок)\b",
     Reply("Срок готовности зависит от анализа. Напишите какой анализ сдавали и когда — подскажу сроки и как проверить статус.")),

    (r"\b(запис|запись|записаться|прием|врач)\b",
     Reply("Запишем. Напишите: 1) что нужно (анализ/врач), 2) желаемую дату/время, 3) телефон для связи.")),

    (r"\b(жалоб|ошибка|претенз|плохое обслуживание)\b",
     Reply("Опишите, пожалуйста, ситуацию (дата, филиал, что произошло). Я передам администратору — с вами свяжутся.", handoff=True)),
]

def match_quick_reply(user_text: str) -> Optional[Reply]:
    t = _norm(user_text)
    if not t:
        return Reply("Напишите, пожалуйста, вопрос: цены / подготовка / адрес / сроки готовности.")
    for pattern, reply in _RULES:
        if re.search(pattern, t, flags=re.IGNORECASE):
            return reply
    return None
